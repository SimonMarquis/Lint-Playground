<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Android Lint SARIF Viewer</title>

    <meta name="title" content="Android Lint SARIF Viewer">
    <meta name="description" content="A modern, offline-first viewer for Android Lint SARIF reports. Analyze your lint issues, filter by severity, and visualize code snippets directly in your browser.">
    <meta name="keywords" content="Android Lint, SARIF, Viewer, Static Analysis, Kotlin, Java, Android Studio, Code Quality, DevOps, CI/CD">
    <meta name="author" content="Simon Marquis">
    <meta name="theme-color" content="#3ddc84">
    <meta name="color-scheme" content="dark light">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://simonmarquis.github.io/Lint-Playground/">
    <meta property="og:title" content="Android Lint SARIF Viewer">
    <meta property="og:description" content="A modern, offline-first viewer for Android Lint SARIF reports. Analyze your lint issues, filter by severity, and visualize code snippets directly in your browser.">
    <meta property="og:image" content="https://simonmarquis.github.io/Lint-Playground/screenshot-dark.png">
    <meta property="og:locale" content="en_US">

    <link rel="canonical" href="https://simonmarquis.github.io/Lint-Playground/">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='48px' viewBox='0 -960 960 960' width='48px' fill='%233ddc84'%3E%3Cpath d='M480-200q66 0 113-47t47-113v-160q0-66-47-113t-113-47q-66 0-113 47t-47 113v160q0 66 47 113t113 47Zm-80-120h160v-80H400v80Zm0-160h160v-80H400v80Zm80 40Zm0 320q-65 0-120.5-32T272-240H160v-80h84q-3-20-3.5-40t-.5-40h-80v-80h80q0-20 .5-40t3.5-40h-84v-80h112q14-23 31.5-43t40.5-35l-64-66 56-56 86 86q28-9 57-9t57 9l88-86 56 56-66 66q23 15 41.5 34.5T688-640h112v80h-84q3 20 3.5 40t.5 40h80v80h-80q0 20-.5 40t-3.5 40h84v80H688q-32 56-87.5 88T480-120Z'/%3E%3C/svg%3E"/>
    <link rel="alternate icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />

    <style>
        :root {
            --primary: #3ddc84;
            --primary-bg: rgba(61, 220, 132, 0.1);
            --bg-body: #121212;
            --bg-surface: #1e1e1e;
            --bg-elevation: #2d2d2d;
            --text-main: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;
            --border: #333333;
            --code-bg: #171717;
            --code-text: #d4d4d4;
            --code-border: #333333;
            --severity-error: #ef5350;
            --severity-warning: #ffca28;
            --severity-info: #42a5f5;
            --header-height: 76px;
        }

        [data-theme="light"] {
            --primary: #00875A;
            --primary-bg: rgba(0, 135, 90, 0.08);
            --bg-body: #e4e7eb;
            --bg-surface: #ffffff;
            --bg-elevation: #e2e8f0;
            --text-main: #1f1f1f;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border: #cdd5df;
            --code-bg: #f6f8fa;
            --code-text: #24292e;
            --code-border: #e1e4e8;
            --severity-error: #d32f2f;
            --severity-warning: #ea580c;
            --severity-info: #0284c7;
        }

        html { scrollbar-gutter: stable; }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .svg-icon { fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .svg-icon-fill { fill: currentColor; stroke: none; }

        header {
            background-color: var(--bg-surface); border-bottom: 1px solid var(--border);
            padding: 1rem 2rem; display: flex; align-items: center; position: sticky;
            top: 0; z-index: 50; transition: background-color 0.3s ease, border-color 0.3s ease;
            gap: 1rem; height: var(--header-height);
        }

        h1 {
            font-size: 1.25rem; font-weight: 600; color: var(--text-main);
            display: flex; align-items: center; gap: 0.5rem;
            min-width: 0; flex: 0 1 auto; user-select: none; cursor: pointer;
        }

        h1 svg { flex-shrink: 0; }
        .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .title-prefix { color: var(--text-main); margin-right: 0.5rem; }
        .title-suffix { color: var(--primary); }

        .header-controls { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; margin-left: auto; }

        #report-info {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center;
            margin-right: 0.5rem; text-align: right; line-height: 1.3;
            max-width: 250px; min-height: 3.2rem;
        }

        .info-line-primary, .info-line-secondary, .info-line-tertiary {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        .info-line-primary { font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        .info-line-secondary { font-size: 0.7rem; color: var(--text-secondary); }
        .info-line-tertiary { font-size: 0.65rem; color: var(--text-tertiary); }

        @media (max-width: 768px) {
            #report-info { max-width: 150px; }
            .title-prefix { display: none; }
        }
        @media (max-width: 480px) {
            header { padding: 0.75rem 1rem; }
            h1 { font-size: 1rem; }
            .header-controls { gap: 0.5rem; }
            #report-info { display: none; }
        }
        @media (max-width: 360px) { .title-suffix { display: none; } }

        .theme-toggle, .header-link, .open-button {
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            padding: 0.5rem; border-radius: 50%;
            transition: color 0.2s ease, background-color 0.2s ease;
            text-decoration: none;
        }

        .theme-toggle:hover, .header-link:hover, .open-button:hover { color: var(--text-main); background-color: var(--bg-elevation); }

        .theme-toggle .icon-sun, .theme-toggle .icon-moon { display: none; }
        [data-theme="dark"] .theme-toggle .icon-sun, [data-theme="light"] .theme-toggle .icon-moon { display: block; }

        main { padding: 2rem; }

        #drop-zone {
            border: 2px dashed var(--border); border-radius: 12px; padding: 4rem 2rem; text-align: center;
            background-color: var(--bg-surface); transition: all 0.2s ease; cursor: pointer;
            margin: 0 auto 2rem; display: flex; flex-direction: column; align-items: center;
            justify-content: center; max-width: 1200px;
        }
        #drop-zone:hover { border-color: var(--text-secondary); background-color: var(--bg-elevation); }
        #drop-zone.highlight { border-color: var(--primary); background-color: var(--primary-bg); }
        #drop-zone > svg { width: 48px; height: 48px; margin-bottom: 1rem; stroke: var(--text-secondary); }

        .drop-text-main { font-size: 1.2rem; font-weight: 500; margin-bottom: 0.5rem; }

        .or-separator {
            display: flex; align-items: center; width: 100%; max-width: 280px;
            margin: 1rem auto; color: var(--text-tertiary); font-size: 0.8rem; user-select: none;
        }
        .or-separator::before, .or-separator::after { content: ""; flex: 1; height: 1px; background: var(--border); }
        .or-separator span { padding: 0 1rem; }

        .drop-actions {
            font-size: 0.85rem; color: var(--text-secondary); text-decoration: underline dotted;
            text-underline-offset: 3px; transition: color 0.2s ease; user-select: none;
            cursor: pointer; display: inline-block;
        }
        .drop-actions:hover { color: var(--primary); text-decoration-style: solid; }
        .drop-actions strong { font-weight: 700; }

        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 50vh; }
        .loader { width: 48px; height: 48px; background: var(--primary); display: inline-block; border-radius: 50%; box-sizing: border-box; animation: animloader 1s ease-in infinite; }
        @keyframes animloader {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        #file-input { display: none; }
        #results-container { max-width: 1200px; margin: 0 auto; }

        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }

        .metric-card {
            --card-accent: var(--text-main); background-color: var(--bg-surface); padding: 1rem; border-radius: 8px;
            border: 1px solid color-mix(in srgb, var(--card-accent) 40%, transparent);
            transition: box-shadow 0.2s ease, border-color 0.2s ease; position: relative; overflow: hidden;
            cursor: pointer; user-select: none;
        }
        .metric-card.is-error { --card-accent: var(--severity-error); }
        .metric-card.is-warning { --card-accent: var(--severity-warning); }
        .metric-card.is-info { --card-accent: var(--severity-info); }
        .metric-card:hover, .metric-card.is-active { box-shadow: 0 4px 12px color-mix(in srgb, var(--card-accent) 30%, transparent); }
        .metric-card.is-active { border-color: var(--card-accent); }

        .metric-icon {
            position: absolute; top: 1rem; right: 1rem; width: 24px; height: 24px; color: var(--card-accent);
            pointer-events: none; display: flex; align-items: center; justify-content: center;
        }
        .metric-icon svg { width: 100%; height: 100%; fill: currentColor; }

        .metric-value { font-size: 2rem; font-weight: 700; color: var(--card-accent); position: relative; z-index: 1; line-height: 1; margin-bottom: 0.25rem; }
        .metric-label { color: var(--card-accent); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; position: relative; z-index: 1; line-height: 1.2; }

        .filter-section, .issue-group, .empty-state { background-color: var(--bg-surface); border-radius: 8px; border: 1px solid var(--border); transition: box-shadow 0.2s ease, border-color 0.2s ease; }
        .filter-section { padding: 1rem; margin-bottom: 1.5rem; display: grid; grid-template-columns: max-content max-content 1fr; gap: 0.5rem 1rem; align-items: start; }
        .filter-section:hover, .issue-group:hover, .empty-state:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-color: var(--text-tertiary); }

        .search-row { grid-column: 1 / -1; margin-bottom: 0.5rem; position: relative; display: flex; align-items: center; }

        .filter-input {
            width: 100%; background-color: var(--bg-body); border: 1px solid var(--border); color: var(--text-main);
            padding: 0.75rem 48px 0.75rem 40px; border-radius: 6px; font-size: 1rem;
        }
        .filter-input:focus { outline: none; border-color: var(--text-tertiary); box-shadow: 0 0 0 1px var(--text-tertiary); }
        .filter-input.is-invalid, .filter-input.is-invalid:focus { border-color: var(--severity-error); box-shadow: 0 0 0 1px var(--severity-error); }
        .filter-input.is-regex { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }

        .regex-toggle {
            position: absolute; right: 8px; background: none; border: 1px solid transparent; color: var(--text-secondary);
            border-radius: 4px; padding: 4px 6px; font-family: monospace; font-weight: 700; cursor: pointer;
            transition: all 0.2s ease; user-select: none; font-size: 0.9rem;
        }
        .regex-toggle:hover { background-color: var(--bg-elevation); color: var(--text-main); }
        .regex-toggle.is-active { background-color: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

        .search-icon { position: absolute; left: 12px; color: var(--text-secondary); pointer-events: none; display: flex; align-items: center; }
        .search-hint { position: absolute; left: 40px; font-size: 0.95rem; color: var(--text-secondary); pointer-events: none; user-select: none; display: flex; align-items: center; gap: 8px; transition: opacity 0.1s ease; }

        kbd {
            background-color: var(--bg-elevation); border: 1px solid var(--border); border-radius: 4px;
            padding: 1px 6px; font-family: inherit; font-size: 0.85rem; color: var(--text-secondary);
            line-height: 1.2; box-shadow: 0 1px 0 var(--border);
        }

        .filter-group { display: contents; }

        .filter-label {
            font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;
            font-weight: 600; white-space: nowrap; height: 24px; display: flex; align-items: center;
        }

        .pill-container { display: flex; flex-wrap: wrap; gap: 0.35rem; }

        .all-pill { justify-content: center; }

        .pill {
            appearance: none; font-family: inherit; background-color: var(--bg-elevation); color: var(--text-secondary);
            border: 1px solid transparent; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.75rem;
            cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            user-select: none; display: inline-flex; align-items: center; justify-content: center; min-width: 0;
            max-width: 100%; line-height: 1.2; vertical-align: middle;
        }
        .pill:hover { background-color: var(--border); color: var(--text-main); }
        .pill:focus { outline: 2px solid var(--text-tertiary); outline-offset: 2px; border-color: var(--text-tertiary); }

        .pill-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex: 0 1 auto; }
        .pill-count { white-space: nowrap; padding-left: 0.35rem; flex: 0 0 auto; }

        .pill.is-active { background-color: var(--primary-bg); color: var(--primary); border-color: var(--primary); text-shadow: 0 0 0.65px currentColor; font-weight: normal; }
        .pill[data-severity="error"].is-active { --pill-color: var(--severity-error); }
        .pill[data-severity="warning"].is-active { --pill-color: var(--severity-warning); }
        .pill[data-severity="info"].is-active { --pill-color: var(--severity-info); }
        .pill[data-severity].is-active { background-color: color-mix(in srgb, var(--pill-color) 15%, transparent); color: var(--pill-color); border-color: var(--pill-color); }

        .issue-list { display: flex; flex-direction: column; gap: 1.5rem; }
        .issue-group { overflow: hidden; content-visibility: auto; contain-intrinsic-size: 500px; border-radius: 12px; }

        .issue-group-header {
            background-color: var(--bg-elevation); padding: 0.8rem 1rem; display: flex; align-items: center;
            justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; user-select: none;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        summary.issue-group-header { cursor: pointer; list-style: none; }
        summary.issue-group-header::-webkit-details-marker { display: none; }

        .issue-group-title { display: flex; align-items: center; gap: 0.75rem; font-family: monospace; font-weight: 700; color: var(--primary); font-size: 1.1rem; flex: 1 1 auto; min-width: 0; margin-right: 0.5rem; }
        .issue-rule-id { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chevron-icon { transition: transform 0.2s ease; flex-shrink: 0; }
        .rule-details[open] .chevron-icon { transform: rotate(90deg); }

        .rule-description-content { padding: 0 1rem 1rem; font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 0; word-break: break-word; overflow-wrap: anywhere; background-color: var(--bg-elevation); }
        .rule-details[open] .rule-description-content { animation: fadeIn 0.2s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .issue-group-meta { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-end; flex-shrink: 0; }
        .issue-group-count { background-color: var(--bg-body); color: var(--text-secondary); padding: 0.1rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border); flex-shrink: 0; }
        .issue-group-content { border-top: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; }

        .issue-card { background-color: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; transition: transform 0.1s ease; }
        .issue-card:hover { border-color: var(--text-tertiary); }

        .category-wrapper { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; max-width: 100%; flex-shrink: 0; }
        .category-badge { background-color: var(--bg-surface); border: 1px solid var(--border); color: var(--text-secondary); padding: 0.2rem 0.6rem; border-radius: 100px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        .severity-icon { width: 1rem; height: 1rem; flex-shrink: 0; cursor: pointer; fill: var(--badge-color); }
        .severity-error { --badge-color: var(--severity-error); }
        .severity-warning { --badge-color: var(--severity-warning); }
        .severity-info { --badge-color: var(--severity-info); }
        .issue-group.is-collapsed .issue-group-content { display: none; }

        .issue-message { font-size: 1rem; margin-bottom: 0.75rem; color: var(--text-main); display: flex; align-items: flex-start; gap: 0.75rem; word-break: break-word; overflow-wrap: anywhere; }

        .markdown-content strong { font-weight: 700; color: var(--text-main); }
        .markdown-content em { font-style: italic; }
        .markdown-content u { text-decoration: underline; text-underline-offset: 3px; }
        .markdown-content del { opacity: 0.7; }
        .markdown-content .formatted-code { background-color: var(--bg-elevation); border: 1px solid var(--border); padding: 0.1rem 0.35rem; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; color: var(--primary); white-space: pre-wrap; word-break: break-word; }
        .markdown-content pre { background-color: var(--code-bg); border: 1px solid var(--code-border); padding: 0.75rem; border-radius: 6px; overflow-x: auto; margin: 0.75rem 0; }
        .markdown-content pre code { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; color: var(--code-text); white-space: pre; background: none; padding: 0; border: none; }

        .issue-location { appearance: none; background-color: var(--bg-surface); padding: 0.5rem 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; text-decoration: none; border: 1px solid transparent; transition: all 0.2s ease; cursor: pointer; width: 100%; text-align: left; overflow: hidden; }
        .issue-location:hover { border-color: var(--text-tertiary); color: var(--text-main); background-color: var(--bg-elevation); }
        .issue-location:focus { outline: 2px solid var(--text-tertiary); outline-offset: 2px; border-color: var(--text-tertiary); }

        .path-dir { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex-shrink: 1; color: var(--text-tertiary); direction: ltr; }
        .path-name { white-space: nowrap; flex-shrink: 0; color: var(--text-secondary); font-weight: 600; }
        .line-number { color: var(--text-tertiary); white-space: nowrap; flex-shrink: 0; }

        .issue-code-snippet { margin-top: 0.8rem; background-color: var(--code-bg); border: 1px solid var(--code-border); border-radius: 6px; padding: 0.75rem 0; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; overflow-x: auto; line-height: 1.4; position: relative; display: grid; grid-template-columns: max-content minmax(max-content, 1fr); }
        .code-line-number { color: var(--text-tertiary); min-width: 3ch; text-align: right; user-select: none; border-right: 1px solid var(--border); padding-right: 0.75rem; padding-left: 0.75rem; position: sticky; left: 0; background-color: var(--code-bg); z-index: 1; }
        .code-content { color: var(--code-text); white-space: pre; padding-left: 1rem; padding-right: 0.75rem; }
        .code-highlight { text-decoration: underline wavy var(--severity-error) 1.5px; background-color: color-mix(in srgb, var(--severity-error) 10%, transparent); }

        .related-location-card { margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; padding-left: 0.75rem; border-left: 2px solid var(--border); }
        .related-location-msg { font-size: 0.75rem; color: var(--text-tertiary); font-style: italic; }

        .is-hidden { display: none !important; }

        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100; animation: slideIn 0.3s ease; font-weight: 500; border: 1px solid transparent; }
        .toast.is-error { background-color: color-mix(in srgb, var(--severity-error) 15%, var(--bg-surface)); color: var(--severity-error); border-color: var(--severity-error); }
        .toast.is-info { background-color: var(--bg-elevation); color: var(--text-main); border-color: var(--primary); }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; }
        .empty-state-title { font-weight: 600; font-size: 1.1rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .empty-state-subtitle { font-size: 0.9rem; color: var(--text-tertiary); }
        .empty-state svg { color: var(--text-secondary); }

        #drag-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background-color: color-mix(in srgb, var(--bg-body) 90%, transparent);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); border: 4px dashed var(--primary); color: var(--primary);
        }
        #drag-overlay svg { width: 64px; height: 64px; stroke: var(--primary); margin-bottom: 1rem; }
        #drag-overlay h2 { font-size: 1.5rem; font-weight: 600; }

        .svg-sprites { display: none; }
        .header-logo { color: var(--primary); }
        .empty-state-icon { stroke-width: 1.5; }
        .chevron-icon-bold { stroke-width: 2.5; }
    </style>
</head>
<body>

<svg class="svg-sprites" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <symbol id="icon-logo" viewBox="0 0 24 24"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></symbol>
        <symbol id="icon-open" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></symbol>
        <symbol id="icon-github" viewBox="0 0 24 24"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></symbol>
        <symbol id="icon-list-outline" viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm80-80h280v-80H280v80Zm0-160h400v-80H280v80Zm0-160h400v-80H280v80Zm221.5-198.5Q510-807 510-820t-8.5-21.5Q493-850 480-850t-21.5 8.5Q450-833 450-820t8.5 21.5Q467-790 480-790t21.5-8.5ZM200-200v-560 560Z"/></symbol>
        <symbol id="icon-list-fill" viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm80-160h280v-80H280v80Zm0-160h400v-80H280v80Zm0-160h400v-80H280v80Zm221.5-198.5Q510-807 510-820t-8.5-21.5Q493-850 480-850t-21.5 8.5Q450-833 450-820t8.5 21.5Q467-790 480-790t21.5-8.5Z"/></symbol>
        <symbol id="icon-error-fill" viewBox="0 -960 960 960"><path d="M363-120q-16 0-30.5-6T307-143L143-307q-11-11-17-25.5t-6-30.5v-234q0-16 6-30.5t17-25.5l164-164q11-11 25.5-17t30.5-6h234q16 0 30.5 6t25.5 17l164 164q11 11 17 25.5t6 30.5v234q0 16-6 30.5T817-307L653-143q-11 11-25.5 17t-30.5 6H363Zm117-304 86 86q11 11 28 11t28-11q11-11 11-28t-11-28l-86-86 86-86q11-11 11-28t-11-28q-11-11-28-11t-28 11l-86 86-86-86q-11-11-28-11t-28 11q-11 11-11 28t11 28l86 86-86 86q-11 11-11 28t11 28q11 11 28 11t28-11l86-86Z"/></symbol>
        <symbol id="icon-error-outline" viewBox="0 -960 960 960"><path d="M363-120q-16 0-30.5-6T307-143L143-307q-11-11-17-25.5t-6-30.5v-234q0-16 6-30.5t17-25.5l164-164q11-11 25.5-17t30.5-6h234q16 0 30.5 6t25.5 17l164 164q11 11 17 25.5t6 30.5v234q0 16-6 30.5T817-307L653-143q-11 11-25.5 17t-30.5 6H363Zm1-80h232l164-164v-232L596-760H364L200-596v232l164 164Zm116-224 86 86q11 11 28 11t28-11q11-11 11-28t-11-28l-86-86 86-86q11-11 11-28t-11-28q-11-11-28-11t-28 11l-86 86-86-86q-11-11-28-11t-28 11q-11 11-11 28t11 28l86 86-86 86q-11 11-11 28t11 28q11 11 28 11t28-11l86-86Zm0-56Z"/></symbol>
        <symbol id="icon-warning-fill" viewBox="0 -960 960 960"><path d="M109-120q-11 0-20-5.5T75-140q-5-9-5.5-19.5T75-180l370-640q6-10 15.5-15t19.5-5q10 0 19.5 5t15.5 15l370 640q6 10 5.5 20.5T885-140q-5 9-14 14.5t-20 5.5H109Zm399.5-131.5Q520-263 520-280t-11.5-28.5Q497-320 480-320t-28.5 11.5Q440-297 440-280t11.5 28.5Q463-240 480-240t28.5-11.5Zm0-120Q520-383 520-400v-120q0-17-11.5-28.5T480-560q-17 0-28.5 11.5T440-520v120q0 17 11.5 28.5T480-360q17 0 28.5-11.5Z"/></symbol>
        <symbol id="icon-warning-outline" viewBox="0 -960 960 960"><path d="M109-120q-11 0-20-5.5T75-140q-5-9-5.5-19.5T75-180l370-640q6-10 15.5-15t19.5-5q10 0 19.5 5t15.5 15l370 640q6 10 5.5 20.5T885-140q-5 9-14 14.5t-20 5.5H109Zm69-80h604L480-720 178-200Zm330.5-51.5Q520-263 520-280t-11.5-28.5Q497-320 480-320t-28.5 11.5Q440-297 440-280t11.5 28.5Q463-240 480-240t28.5-11.5Zm0-120Q520-383 520-400v-120q0-17-11.5-28.5T480-560q-17 0-28.5 11.5T440-520v120q0 17 11.5 28.5T480-360q17 0 28.5-11.5ZM480-460Z"/></symbol>
        <symbol id="icon-info-fill" viewBox="0 -960 960 960"><path d="M508.5-291.5Q520-303 520-320v-160q0-17-11.5-28.5T480-520q-17 0-28.5 11.5T440-480v160q0 17 11.5 28.5T480-280q17 0 28.5-11.5Zm0-320Q520-623 520-640t-11.5-28.5Q497-680 480-680t-28.5 11.5Q440-657 440-640t11.5 28.5Q463-600 480-600t28.5-11.5ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></symbol>
        <symbol id="icon-info-outline" viewBox="0 -960 960 960"><path d="M508.5-291.5Q520-303 520-320v-160q0-17-11.5-28.5T480-520q-17 0-28.5 11.5T440-480v160q0 17 11.5 28.5T480-280q17 0 28.5-11.5Zm0-320Q520-623 520-640t-11.5-28.5Q497-680 480-680t-28.5 11.5Q440-657 440-640t11.5 28.5Q463-600 480-600t28.5-11.5ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
        <symbol id="icon-empty-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></symbol>
        <symbol id="icon-empty-report" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></symbol>
    </defs>
</svg>

<header>
    <h1>
        <svg class="svg-icon-fill header-logo" width="28" height="28"><use href="#icon-logo"/></svg>
        <span class="title-text">
            <span class="title-prefix">Android Lint</span><span class="title-suffix">SARIF Viewer</span>
        </span>
    </h1>
    <div class="header-controls">
        <div id="report-info"></div>

        <button id="open-button" class="open-button" title="Load New File">
            <svg class="svg-icon" width="20" height="20"><use href="#icon-open"/></svg>
        </button>
        <button id="theme-toggle" class="theme-toggle" title="Toggle Theme">
            <svg class="icon-sun svg-icon" width="20" height="20"><use href="#icon-sun"/></svg>
            <svg class="icon-moon svg-icon" width="20" height="20"><use href="#icon-moon"/></svg>
        </button>
        <a href="https://github.com/SimonMarquis/Lint-Playground?utm_source=sarif-viewer" target="_blank" rel="noopener noreferrer" class="header-link" title="View on GitHub">
            <svg class="svg-icon" width="20" height="20"><use href="#icon-github"/></svg>
        </a>
    </div>
</header>

<main>
    <div id="loader-container" class="loader-container">
        <span class="loader"></span>
    </div>

    <div id="drop-zone" class="is-hidden">
        <svg class="svg-icon"><use href="#icon-open"/></svg>
        <div class="drop-text-main">Drop your SARIF file here</div>

        <div id="example-container" class="is-hidden">
            <div class="or-separator">
                <span>or</span>
            </div>

            <div class="drop-actions" id="load-example-wrapper"></div>
        </div>
        <input type="file" id="file-input" accept=".sarif,.json">
    </div>

    <div id="results-container" class="is-hidden">
        <div class="metric-grid">
            <div class="metric-card is-active" data-value="all">
                <div class="metric-icon"><svg class="svg-icon"><use href="#icon-list-fill"/></svg></div>
                <div class="metric-value" id="metric-total">0</div>
                <div class="metric-label">Total Issues</div>
            </div>
            <div class="metric-card is-error" data-value="error">
                <div class="metric-icon"><svg class="svg-icon"><use href="#icon-error-outline"/></svg></div>
                <div class="metric-value" id="metric-errors">0</div>
                <div class="metric-label">Errors</div>
            </div>
            <div class="metric-card is-warning" data-value="warning">
                <div class="metric-icon"><svg class="svg-icon"><use href="#icon-warning-outline"/></svg></div>
                <div class="metric-value" id="metric-warnings">0</div>
                <div class="metric-label">Warnings</div>
            </div>
            <div class="metric-card is-info" data-value="info">
                <div class="metric-icon"><svg class="svg-icon"><use href="#icon-info-outline"/></svg></div>
                <div class="metric-value" id="metric-info">0</div>
                <div class="metric-label">Hints</div>
            </div>
        </div>

        <div class="filter-section">
            <div class="search-row">
                <div class="search-icon"><svg class="svg-icon" width="20" height="20"><use href="#icon-search"/></svg></div>
                <input type="text" id="filter-text" class="filter-input">
                <span class="search-hint" id="search-hint">Type <kbd>/</kbd> to search</span>
                <button id="regex-toggle" class="regex-toggle" title="Use Regular Expression">.*</button>
            </div>
            <div class="filter-group" id="severity-group">
                <div class="filter-label">Severity</div>
                <button class="pill is-active all-pill" data-value="all">All</button>
                <div class="pill-container" id="severity-pills">
                    <button class="pill" data-value="error" data-severity="error">Error</button>
                    <button class="pill" data-value="warning" data-severity="warning">Warning</button>
                    <button class="pill" data-value="info" data-severity="info">Hint</button>
                </div>
            </div>
            <div class="filter-group" id="category-group">
                <div class="filter-label">Category</div>
                <button class="pill is-active all-pill" data-value="all">All</button>
                <div class="pill-container" id="category-pills"></div>
            </div>
            <div class="filter-group" id="issue-group">
                <div class="filter-label">Issue ID</div>
                <button class="pill is-active all-pill" data-value="all">All</button>
                <div class="pill-container" id="issue-pills"></div>
            </div>
        </div>

        <div id="issue-list" class="issue-list"></div>

        <div id="empty-filter-state" class="empty-state is-hidden">
            <svg class="svg-icon empty-state-icon" width="64" height="64"><use href="#icon-empty-search"/></svg>
            <span class="empty-state-title">No matching issues found!</span>
            <span class="empty-state-subtitle">Try adjusting your filters or search query.</span>
        </div>

        <div id="empty-report-state" class="empty-state is-hidden">
            <svg class="svg-icon empty-state-icon" width="64" height="64"><use href="#icon-empty-report"/></svg>
            <span class="empty-state-title">No issues found!</span>
            <span class="empty-state-subtitle">This report contains no lint issues. Great job!</span>
        </div>
    </div>
</main>

<template id="tpl-issue-group">
    <div class="issue-group">
        <details class="rule-details">
            <summary class="issue-group-header">
                <div class="issue-group-title">
                    <svg class="severity-icon"><use href=""></use></svg>
                    <span class="issue-rule-id"></span>
                    <svg class="chevron-icon svg-icon chevron-icon-bold" width="18" height="18"><use href="#icon-chevron"/></svg>
                </div>
                <div class="issue-group-meta">
                    <div class="category-wrapper"></div>
                    <span class="issue-group-count"></span>
                </div>
            </summary>
            <div class="rule-description-content markdown-content"></div>
        </details>
        <div class="issue-group-content"></div>
    </div>
</template>

<div id="toast" class="toast is-hidden"></div>

<div id="drag-overlay" class="is-hidden">
    <svg class="svg-icon"><use href="#icon-open"/></svg>
    <h2>Drop to Load New File</h2>
</div>

<!--region SARIF-->
<script id="sarif-example" data-src="lint-results-demoDebug.sarif" data-project="android/nowinandroid" type="application/json"></script>
<!-- Placeholders for embedded report (populated by CI/CD or other tools) -->
<!--SARIF raw-->
<!--<script id="sarif-report" type="application/json">{...}</script>-->
<!--SARIF file-->
<!--<script id="sarif-report" type="application/json" data-src="lint-results-demoDebug.sarif"></script>-->
<!--SARIF b64 GZIP-->
<!--<script id="sarif-report" type="application/gzip+base64">H4sICJmRi2kAA3NtYWxsLnNhcmlmAMVVTW/bMAz9K4IwoIel9up2wJqlWbvusAIdMDTdaRkCxWJsDbZkSHTSrMh/H2U7qfPdw4A5h+iDfHokn6hn/sbFKeSCd3mKWLhuGFoxCxKFaTkuHdjYaASNQWzy0Ain3CnGLnTCqsmpKyAOc+EQbDioYFAst6rpaRScBe+C385o3uFTsE7RqMurZVqxpXa8+/OZozEZ7z5zaRVZ+ZEWOZDljZbWKMnulcY1iA9B1EBkUGMoSctfhZWxkSAf4ck7uNRY/AIutqrAypMO81stU1YtLDpcwkSUGd4aPVFJacXSIYMpED0O1hrrDQtrCrCo/MmEJxLPgN8aayFGDc7RyXeUN6srDJGpPzXYr8Wi0zD9oSm98gGcKW0M7jDX2pjZlfUr2M6E1Uon+/l+BzsxNhc6hjaxx3lhjtAZFJBlhM1WGTlGRhuE12WOmHgynGIlwLq0vsh3u8qbk4dIYGdVHVpPccgH5ThXOOQdRiGVmWSUS3bdbC9T6smt15nmJq4CqUkU6dypWGT3zao/VFAoExFje620ijBEUYTO+uuhdEiHhJmYmxJDMlZThfOR3wie8oxXsSaNs0OCJLFTSGfvO/X01mRlTrvReYeDli+7NFntXRJMdVef8GEnWkRoWhUFYCtbjL7e5xLR6KFmzSfqO9dV8mrIr98qGboqg6Nxbci3TevgRjMlMSWnmRXFqOkcu8z96VcvhdmLl4JKUtwCZGGfLxZeJ52WNrYv1LY6HlNYVZydPAS1CIKych3VsxNGtQNhHUPDxsDqzbY+ljfrHytkKrKS/moW7qA2LjakcXbZksbFmjLOoyPK2C+M5or4Vkw1IL4jPxzy/rc5uymKXkO1X9dv0zz24Y4cIPpwyGvQDA/7rdWCvJrWN6jmh10zkyiSZ//e/69Md0hl2eK2BULtwj85ykiSmXJMMHr4cqNZrpxrut5HJulFIoGyHIRuPEi1Q/6prZKq5f0/iUQbEjmPWhKJ1iVytHnskkhv9RrtEcC6XuqsbuimF76ANHXyv7+XESPqlwgAAA==</script>-->
<!--endregion SARIF-->

<script>
    // #region Utilities
    const Perf = {
        start: (name) => performance.mark(`${name}-start`),
        end: (name) => {
            performance.mark(`${name}-end`);
            performance.measure(name, `${name}-start`, `${name}-end`);
            console.log(`⏱️ [${name}] ${Number(performance.getEntriesByName(name).pop().duration.toFixed(2))} ms`);
            performance.clearMarks(`${name}-start`);
            performance.clearMarks(`${name}-end`);
            performance.clearMeasures(name);
        }
    };

    const debounce = (fn, delay) => {
        let timeoutId;
        return (...args) => {
            const callNow = !timeoutId;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                timeoutId = null;
                if (!callNow) fn(...args);
            }, delay);
            if (callNow) fn(...args);
        };
    };

    const normalize = (str) =>
      str.normalize("NFD")
         .replace(/[\u0300-\u036f]/g, "")
         .toLowerCase();

    const FILTER_ALL = 'all';
    // #endregion

    // #region State
    const DOM = {
        themeToggle: document.getElementById('theme-toggle'),
        dropZone: document.getElementById('drop-zone'),
        fileInput: document.getElementById('file-input'),
        resultsContainer: document.getElementById('results-container'),
        reportInfo: document.getElementById('report-info'),
        openButton: document.getElementById('open-button'),
        issueList: document.getElementById('issue-list'),
        emptyFilterState: document.getElementById('empty-filter-state'),
        emptyReportState: document.getElementById('empty-report-state'),
        filterText: document.getElementById('filter-text'),
        searchHint: document.getElementById('search-hint'),
        regexToggle: document.getElementById('regex-toggle'),
        dragOverlay: document.getElementById('drag-overlay'),
        loaderContainer: document.getElementById('loader-container'),
        exampleContainer: document.getElementById('example-container'),
        loadExampleWrapper: document.getElementById('load-example-wrapper'),
        toast: document.getElementById('toast'),
        metrics: {
            grid: document.querySelector('.metric-grid'),
            total: document.getElementById('metric-total'),
            error: document.getElementById('metric-errors'),
            warning: document.getElementById('metric-warnings'),
            info: document.getElementById('metric-info')
        },
        filters: {
            severities: { param: 'severity', group: document.getElementById('severity-group'), pills: document.getElementById('severity-pills') },
            categories: { param: 'category', group: document.getElementById('category-group'), pills: document.getElementById('category-pills') },
            issueIds: { param: 'issueId', group: document.getElementById('issue-group'), pills: document.getElementById('issue-pills') }
        },
        templates: {
            group: document.getElementById('tpl-issue-group')
        }
    };

    const state = {
        rawIssues: [],
        filteredIssues: [],
        categories: new Set(),
        issueIds: new Set(),
        rules: new Map(),
        filename: '',
        driverInfo: { name: '', version: '' },
        reportDate: null,
        fileLastModified: null,
        filters: {
            text: '',
            isRegex: false,
            categories: new Set([FILTER_ALL]),
            issueIds: new Set([FILTER_ALL]),
            severities: new Set([FILTER_ALL])
        }
    };
    // #endregion

    // #region Helpers
    function parseJson(text) {
        Perf.start('JSON Parse');
        const json = JSON.parse(text);
        Perf.end('JSON Parse');
        return json;
    }

    async function decodeGzipBase64(base64) {
        if (!("DecompressionStream" in window)) {
            showError("DecompressionStream('gzip') not supported in this browser.");
            return null;
        }
        try {
            Perf.start('Base64 Decode & Unzip');
            const bytes = Uint8Array.from(atob(base64.trim()), c => c.charCodeAt(0));
            const stream = new Blob([bytes]).stream().pipeThrough(new DecompressionStream("gzip"));
            const text = await new Response(stream).text();
            Perf.end('Base64 Decode & Unzip');
            return text;
        } catch (err) {
            console.error("Decompression failed", err);
            showError(`Failed to decompress embedded file: ${err.message}`);
            return null;
        }
    }

    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showToast('Path copied to clipboard!', false);
        } catch (err) {
            console.error('Failed to copy: ', err);
            showToast('Failed to copy to clipboard', true);
        }
    }

    function showToast(message, isError = false) {
        DOM.toast.textContent = message;
        DOM.toast.className = `toast ${isError ? 'is-error' : 'is-info'}`;
        DOM.toast.classList.remove('is-hidden');
        setTimeout(() => DOM.toast.classList.add('is-hidden'), isError ? 10000 : 3000);
    }

    function showError(message) {
        showToast(message, true);
    }

    function sanitize(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatMarkdown(text) {
        if (!text) return '';
        return sanitize(text).split(/(```[\s\S]*?```|`[^`]+`)/).map(part => {
            if (part.startsWith('```') && part.endsWith('```')) {
                const [, lang, content] = part.match(/```(\w*)\n?([\s\S]*?)```/) || [];
                return content ? `<pre><code${lang ? ` class="language-${lang}"` : ''}>${content.trimEnd()}</code></pre>` : part;
            }
            if (part.startsWith('`') && part.endsWith('`') && part.length > 1) {
                return `<code class="formatted-code">${part.slice(1, -1)}</code>`;
            }
            return part.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                       .replace(/__([^_]+)__/g, '<u>$1</u>')
                       .replace(/~~([^~]+)~~/g, '<del>$1</del>')
                       .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                       .replace(/\n/g, '<br>');
        }).join('');
    }

    function getSeverity(level) {
        const severity = (level || 'warning').toLowerCase();
        if (severity === 'error') return 'error';
        if (severity === 'note' || severity === 'none') return 'info';
        return 'warning';
    }
    // #endregion

    // #region SARIF
    function processSarif(sarif) {
        if (!sarif?.runs || !Array.isArray(sarif.runs)) {
            throw new Error("Invalid SARIF: Missing 'runs' array.");
        }

        const run = sarif.runs[0] || {};
        const driver = run.tool?.driver || {};
        state.driverInfo = {
            name: driver.fullName || driver.name || "Unknown Tool",
            version: driver.semanticVersion || driver.version || ""
        };

        const dateValue = run.invocations?.[0]?.endTimeUtc || run.invocations?.[0]?.startTimeUtc || sarif.time;
        state.reportDate = dateValue ? new Date(dateValue) : (state.fileLastModified ? new Date(state.fileLastModified) : new Date());

        const getMarkdownOrText = obj => obj?.markdown || obj?.text || "";

        Perf.start('Extract Rules');
        state.rules.clear();
        (driver.rules || []).forEach(rule => {
            state.rules.set(rule.id, {
                label: rule.shortDescription?.text,
                categories: rule.tags || rule.properties?.tags || ["General"],
                level: rule.defaultConfiguration?.level || "warning",
                description: getMarkdownOrText(rule.fullDescription)
            });
        });
        Perf.end('Extract Rules');

        Perf.start('Extract Issues');
        state.rawIssues = (run.results || []).map(result => {
            const rule = state.rules.get(result.ruleId);
            const location = result.locations?.[0]?.physicalLocation;
            const context = location?.contextRegion;

            return {
                id: result.ruleId,
                categories: rule?.categories,
                message: getMarkdownOrText(result.message) || "No message",
                file: location?.artifactLocation?.uri || "Unknown",
                line: location?.region?.startLine,
                column: location?.region?.startColumn,
                level: result.level || rule?.level || "warning",
                snippet: context?.snippet?.text ? {
                    text: context?.snippet.text,
                    startLine: context?.startLine
                } : null,
                region: location?.region || {},
                relatedLocations: (result.relatedLocations || []).map(related => ({
                    file: related.physicalLocation?.artifactLocation?.uri || "Unknown",
                    line: related.physicalLocation?.region?.startLine,
                    column: related.physicalLocation?.region?.startColumn,
                    message: getMarkdownOrText(related.message) || ""
                }))
            };
        }).sort((a, b) => a.file.localeCompare(b.file) || (a.line || 0) - (b.line || 0) || (a.column || 0) - (b.column || 0));
        Perf.end('Extract Issues');

        state.categories = new Set(state.rawIssues.flatMap(issue => issue.categories));
        state.filters.categories.forEach(c => { if (c !== FILTER_ALL) state.categories.add(c); });
        renderPills('categories');

        state.issueIds = new Set(state.rawIssues.map(issue => issue.id));
        state.filters.issueIds.forEach(id => { if (id !== FILTER_ALL) state.issueIds.add(id); });
        renderPills('issueIds');

        updateMetrics();
        applyFilters();
    }

    async function loadSarifFromScript(elementId, defaultFilename, keepUrlParams = false) {
        const element = document.getElementById(elementId);
        if (!element) return false;

        const src = element.getAttribute('data-src');
        const type = element.getAttribute('type');
        const content = element.textContent.trim();
        if (!src && !content) return false;

        Perf.start('Fetch / Process Data');
        let json = null;
        try {
            if (src) {
                const response = await fetch(src);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                json = await response.text();
            } else if (type === 'application/json') {
                json = content;
            } else if (type === 'application/gzip+base64') {
                json = await decodeGzipBase64(content);
            } else {
                throw new Error("Unknown data format type.");
            }
            json = parseJson(json);
        } finally {
            Perf.end('Fetch / Process Data');
        }

        if (!json) return false;
        loadSarifData(json, element.getAttribute('title') || src || defaultFilename, Date.now(), keepUrlParams);
        return true;
    }

    function loadSarifData(json, filename, lastModified, keepUrlParams = false) {
        resetApp(!keepUrlParams);
        state.filename = filename || "Unknown";
        state.fileLastModified = lastModified || Date.now();
        processSarif(json);
        updateMetricCards(state.filters.severities);
        updatePillStates('severities');
        showResultsUI();
    }

    function handleFiles(files) {
        if (!files || files.length === 0) return;
        const file = files[0];
        const fileName = file.name.toLowerCase();

        if (!fileName.endsWith('.sarif') && !fileName.endsWith('.json')) {
            return showError("Invalid file format. Please use .sarif or .json files.");
        }

        Perf.start('File Read');
        const reader = new FileReader();
        reader.onload = event => {
            Perf.end('File Read');
            try {
                loadSarifData(parseJson(event.target.result), file.name, file.lastModified);
            } catch (err) {
                state.filename = '';
                DOM.reportInfo.innerHTML = '';
                showError(err.message || "Could not parse JSON.");
            }
        };
        reader.onerror = () => {
            Perf.end('File Read');
            showError("Error reading file.");
        };
        reader.readAsText(file);
    }
    // #endregion

    // #region Logic
    function applyTheme(theme, persist = true) {
        document.documentElement.setAttribute('data-theme', theme);
        if (persist) localStorage.setItem('theme', theme);
    }

    function applyFilters() {
        Perf.start('Filtering');

        let needsCategoriesPillsRender = false;
        state.filters.categories.forEach(c => {
            if (c == FILTER_ALL || state.categories.has(c)) return
            state.categories.add(c);
            needsCategoriesPillsRender = true;
        });
        if (needsCategoriesPillsRender) renderPills('categories');

        let needsIssueIdsPillsRender = false;
        state.filters.issueIds.forEach(id => {
            if (id == FILTER_ALL || state.issueIds.has(id)) return
            state.issueIds.add(id);
            needsIssueIdsPillsRender = true;
        });
        if (needsIssueIdsPillsRender) renderPills('issueIds');

        const query = state.filters.text;
        const queryNormalized = normalize(query);

        let regex = null;
        DOM.filterText.classList.remove('is-invalid');
        if (state.filters.isRegex && query) {
            try {
                regex = new RegExp(query, 'i');
            } catch (e) {
                DOM.filterText.classList.add('is-invalid');
            }
        }

        const matchedIssues = state.rawIssues.filter(issue => {
            if (!query) return true;
            if (state.filters.isRegex && regex) return regex.test(issue.id) || regex.test(issue.message) || regex.test(issue.file);
            return normalize(issue.id).includes(queryNormalized) ||
                   normalize(issue.message).includes(queryNormalized) ||
                   normalize(issue.file).includes(queryNormalized);
        });

        updatePillCounts(matchedIssues);

        state.filteredIssues = matchedIssues.filter(issue => {
            if (!state.filters.severities.has(FILTER_ALL) && !state.filters.severities.has(getSeverity(issue.level))) return false;
            if (!state.filters.categories.has(FILTER_ALL) && !issue.categories.some(c => state.filters.categories.has(c))) return false;
            if (!state.filters.issueIds.has(FILTER_ALL) && !state.filters.issueIds.has(issue.id)) return false;
            return true;
        });

        updateURL();
        Perf.end('Filtering');

        Perf.start('Rendering UI');
        renderList();
        Perf.end('Rendering UI');
    }

    function resetApp(resetFilters = true) {
        if (resetFilters) {
            state.filters.text = '';
            state.filters.isRegex = false;
            state.filters.categories = new Set([FILTER_ALL]);
            state.filters.issueIds = new Set([FILTER_ALL]);
            state.filters.severities = new Set([FILTER_ALL]);
            updateURL();
        }

        Object.assign(state, {
            rawIssues: [],
            filteredIssues: [],
            categories: new Set(),
            issueIds: new Set(),
            rules: new Map(),
            filename: '',
            driverInfo: { name: '', version: '' },
            reportDate: null,
            fileLastModified: null
        });

        DOM.dropZone.classList.remove('is-hidden');
        DOM.loaderContainer.classList.add('is-hidden');
        DOM.resultsContainer.classList.add('is-hidden');
        DOM.reportInfo.innerHTML = '';
        DOM.fileInput.value = '';

        DOM.filterText.value = state.filters.text;
        DOM.searchHint.style.opacity = state.filters.text ? '0' : '1';
        DOM.regexToggle.classList.toggle('is-active', state.filters.isRegex);
        DOM.filterText.classList.toggle('is-regex', state.filters.isRegex);

        renderPills('categories');
        renderPills('issueIds');
        updatePillStates('severities');

        updateMetricCards(state.filters.severities);
    }

    function readURL() {
        const params = new URLSearchParams(window.location.search);
        state.filters.text = params.get('query') || '';
        DOM.filterText.value = state.filters.text;
        DOM.searchHint.style.opacity = state.filters.text ? '0' : '1';

        state.filters.isRegex = params.get('regex') === 'true';
        DOM.regexToggle.classList.toggle('is-active', state.filters.isRegex);
        DOM.filterText.classList.toggle('is-regex', state.filters.isRegex);

        Object.entries(DOM.filters).forEach(([type, config]) => {
            const value = params.get(config.param);
            state.filters[type].clear();
            if (value) {
                value.split(',').forEach(v => state.filters[type].add(v.trim()));
            } else {
                state.filters[type].add(FILTER_ALL);
            }
        });
    }

    function updateURL() {
        const params = new URLSearchParams();
        if (state.filters.text) params.set('query', state.filters.text);
        if (state.filters.isRegex) params.set('regex', 'true');

        Object.entries(DOM.filters).forEach(([type, config]) => {
            const set = state.filters[type];
            if (!set.has(FILTER_ALL) && set.size > 0) {
                params.set(config.param, Array.from(set).join(','));
            }
        });

        const queryString = params.toString();
        const newUrl = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
        try {
            window.history.replaceState({ path: newUrl }, '', newUrl);
        } catch (e) {}
    }
    // #endregion

    // #region Rendering
    function renderList() {
        DOM.issueList.innerHTML = '';
        DOM.emptyFilterState.classList.add('is-hidden');
        DOM.emptyReportState.classList.add('is-hidden');

        if (state.rawIssues.length === 0) return DOM.emptyReportState.classList.remove('is-hidden');
        if (state.filteredIssues.length === 0) return DOM.emptyFilterState.classList.remove('is-hidden');

        const groups = state.filteredIssues.reduce((acc, issue) => {
            const key = `${issue.id}::${issue.level}`;
            if (!acc[key]) acc[key] = { id: issue.id, level: issue.level, categories: issue.categories, issues: [] };
            acc[key].issues.push(issue);
            return acc;
        }, {});

        const fragment = document.createDocumentFragment();
        const weight = { error: 3, warning: 2, info: 1 };

        Object.values(groups).sort((a, b) => {
            const diff = a.id.localeCompare(b.id);
            return diff !== 0 ? diff : weight[getSeverity(b.level)] - weight[getSeverity(a.level)];
        }).forEach(group => {
            const rule = state.rules.get(group.id);
            const description = rule?.description || "No description provided.";
            const severityClass = `severity-${getSeverity(group.level)}`;

            const groupClone = DOM.templates.group.content.cloneNode(true);
            const groupElement = groupClone.querySelector('.issue-group');
            groupElement.classList.add(severityClass);

            const severity = getSeverity(group.level);
            const icon = groupClone.querySelector('.severity-icon');
            icon.classList.add(`severity-${severity}`);
            icon.querySelector('use').setAttribute('href', `#icon-${severity}-fill`);

            const groupIdElement = groupClone.querySelector('.issue-rule-id');
            groupIdElement.textContent = group.id;
            groupIdElement.setAttribute('title', sanitize(rule.label));
            const titleElement = groupClone.querySelector('.issue-group-title');
            titleElement.style.color = `var(--badge-color)`;

            const categoryWrapper = groupClone.querySelector('.category-wrapper');
            categoryWrapper.innerHTML = group.categories.map(category => `<span class="category-badge">${sanitize(category)}</span>`).join('');

            groupClone.querySelector('.issue-group-count').textContent = group.issues.length;
            groupClone.querySelector('.rule-description-content').innerHTML = formatMarkdown(description);

            let cardsHtml = '';
            group.issues.forEach(issue => {
                cardsHtml += `<div class="issue-card"><div class="issue-message markdown-content"><span>${formatMarkdown(issue.message)}</span></div>`;
                cardsHtml += createLocationHtml(issue.file, issue.line, issue.column);

                issue.relatedLocations?.forEach(related => {
                    cardsHtml += `<div class="related-location-card">`;
                    if (related.message) cardsHtml += `<div class="related-location-msg">${formatMarkdown(related.message)}</div>`;
                    cardsHtml += createLocationHtml(related.file, related.line, related.column);
                    cardsHtml += `</div>`;
                });

                if (issue.snippet) {
                    const lineHtml = issue.snippet.text.split('\n').map((text, idx) => {
                        let codeText = sanitize(text);
                        const currentLine = issue.snippet.startLine ? issue.snippet.startLine + idx : '';
                        const region = issue.region;
                        const startLine = region.startLine;
                        const endLine = region.endLine || startLine;

                        if (currentLine && startLine && currentLine >= startLine && currentLine <= endLine) {
                            const startCol = currentLine === startLine ? Math.max(0, (region.startColumn || 1) - 1) : 0;
                            const endCol = currentLine === endLine && region.endColumn ? Math.min(text.length, region.endColumn - 1) : text.length;
                            codeText = `${sanitize(text.substring(0, startCol))}<span class="code-highlight">` +
                                       `${sanitize(text.substring(startCol, endCol))}</span>${sanitize(text.substring(endCol))}`;
                        }
                        return `<span class="code-line-number">${currentLine}</span><span class="code-content">${codeText}</span>`;
                    }).join('');
                    cardsHtml += `<div class="issue-code-snippet">${lineHtml}</div>`;
                }
                cardsHtml += `</div>`;
            });

            groupClone.querySelector('.issue-group-content').innerHTML = cardsHtml;
            fragment.appendChild(groupClone);
        });
        DOM.issueList.appendChild(fragment);
    }

    function createLocationHtml(file, line, column) {
        const lastIndex = file.lastIndexOf('/');
        const dir = sanitize(file.substring(0, lastIndex + 1));
        const name = sanitize(file.substring(lastIndex + 1));
        const showLine = line > 1 || (line === 1 && column > 0);
        const showColumn = showLine && column > 0;
        const linePart = showLine ? `:${line}` : '';
        const colPart = showColumn ? `:${column}` : '';
        const lineHtml = showLine ? `<span class="line-number">${linePart}</span>` : '';
        const colHtml = showColumn ? `<span class="line-number">${colPart}</span>` : '';
        return `<button class="issue-location"><span class="path-dir">${dir}</span><span class="path-name">${name}</span>${lineHtml}${colHtml}</button>`;
    }

    function renderPills(type) {
        const filter = DOM.filters[type];
        const items = state[type];
        const filters = state.filters[type];
        if (!filter || !items || !filters) return;

        filter.pills.innerHTML = Array.from(items).sort().map(item => {
            const activeClass = filters.has(item) ? ' is-active' : '';
            const sanitized = sanitize(item);
            return `<button class="pill${activeClass}" data-value="${sanitized}"><span class="pill-label">${sanitized}</span><span class="pill-count"></span></button>`;
        }).join('');
    }

    function updatePillStates(type) {
        const filter = DOM.filters[type];
        const filters = state.filters[type];
        if (!filter || !filters) return;
        Array.from(filter.group.querySelectorAll('.pill')).forEach(pill => {
            pill.classList.toggle('is-active', filters.has(pill.getAttribute('data-value')));
        });
    }

    function updatePillCounts(issues) {
        const counts = { categories: {}, issueIds: {}, severities: { error: 0, warning: 0, info: 0 } };
        issues.forEach(issue => {
            counts.issueIds[issue.id] = (counts.issueIds[issue.id] || 0) + 1;
            issue.categories.forEach(category => counts.categories[category] = (counts.categories[category] || 0) + 1);
            counts.severities[getSeverity(issue.level)]++;
        });

        const update = (type, val, count, label) => {
            const element = DOM.filters[type].group.querySelector(`[data-value="${val}"]`);
            if (!element) return;
            const name = label || val;
            element.innerHTML = `<span class="pill-label">${sanitize(name)}</span><span class="pill-count">(${count})</span>`;

            const isActive = state.filters[type].has(val);
            const matchesQuery = state.filters.text && name.toLowerCase().includes(state.filters.text.toLowerCase());

            element.classList.toggle('is-hidden', count === 0 && val !== FILTER_ALL && !isActive && !matchesQuery);
            element.classList.toggle('is-active', isActive);
        };

        const SEVERITY_LABELS = { error: 'Error', warning: 'Warning', info: 'Hint' };
        Object.keys(SEVERITY_LABELS).forEach(severity => update('severities', severity, counts.severities[severity], SEVERITY_LABELS[severity]));
        Array.from(state.categories).forEach(category => update('categories', category, counts.categories[category] || 0));
        Array.from(state.issueIds).forEach(id => update('issueIds', id, counts.issueIds[id] || 0));
    }

    function updateMetrics() {
        const counts = { error: 0, warning: 0, info: 0 };
        state.rawIssues.forEach(issue => counts[getSeverity(issue.level)]++);

        DOM.metrics.total.textContent = state.rawIssues.length;
        DOM.metrics.error.textContent = counts.error;
        DOM.metrics.warning.textContent = counts.warning;
        DOM.metrics.info.textContent = counts.info;
    }

    function updateMetricCards(filters) {
        Array.from(DOM.metrics.grid.children).forEach(card => {
            const value = card.getAttribute('data-value');
            const isActive = filters.has(value);
            card.classList.toggle('is-active', isActive);
            card.querySelector('use').setAttribute('href', `#icon-${value === 'all' ? 'list' : value}-${isActive ? 'fill' : 'outline'}`);
        });
    }

    function showResultsUI() {
        DOM.dropZone.classList.add('is-hidden');
        DOM.loaderContainer.classList.add('is-hidden');
        DOM.resultsContainer.classList.remove('is-hidden');
        const toolStr = `${state.driverInfo.name} ${state.driverInfo.version ? 'v' + state.driverInfo.version : ''}`;
        const dateStr = state.reportDate?.toLocaleString() || '';
        DOM.reportInfo.innerHTML = `
            <div class="info-line-primary">${sanitize(state.filename)}</div>
            <div class="info-line-secondary">${sanitize(toolStr)}</div>
            <div class="info-line-tertiary" title="${sanitize(dateStr)}">${sanitize(dateStr)}</div>
        `;
    }

    function handlePillClick(event, filterType) {
        const target = event.target.closest('.pill') || event.target.closest('.metric-card');
        if (!target) return;

        const value = target.getAttribute('data-value');
        const filters = state.filters[filterType];

        if (value === FILTER_ALL) {
            filters.clear();
            filters.add(FILTER_ALL);
        } else {
            filters.delete(FILTER_ALL);
            if (filters.has(value)) filters.delete(value);
            else filters.add(value);
            if (filters.size === 0) filters.add(FILTER_ALL);
        }

        if (filterType === 'severities') updateMetricCards(state.filters.severities);

        updatePillStates(filterType);

        applyFilters();
    }

    function setAllGroupsCollapsed(collapsed) {
        DOM.issueList.querySelectorAll('.issue-group').forEach(group => {
            group.classList.toggle('is-collapsed', collapsed);
            const use = group.querySelector('.severity-icon use');
            if (!use) return;
            const href = use.getAttribute('href');
            use.setAttribute('href', collapsed ? href.replace('-fill', '-outline') : href.replace('-outline', '-fill'));
        });
    }
    // #endregion

    // #region Event listeners
    DOM.themeToggle.addEventListener('click', () => {
        applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark', true);
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (!localStorage.getItem('theme')) applyTheme(event.matches ? 'dark' : 'light', false);
    });

    document.querySelector('header h1').addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

    window.addEventListener('popstate', () => {
        readURL();
        if (state.rawIssues.length === 0) return;
        updateMetricCards(state.filters.severities);
        Object.entries(DOM.filters).forEach(([type]) => updatePillStates(type));
        applyFilters();
    });

    window.addEventListener('keydown', event => {
        // Search
        if (event.key === '/' && document.activeElement !== DOM.filterText && DOM.resultsContainer.style.display !== 'none') {
            event.preventDefault();
            DOM.filterText.focus();
        }
        // Collapse all
        if (event.ctrlKey && event.shiftKey && event.code === 'NumpadSubtract') {
            event.preventDefault();
            setAllGroupsCollapsed(true);
        }
        // Expand all
        if (event.ctrlKey && event.shiftKey && event.code === 'NumpadAdd') {
            event.preventDefault();
            setAllGroupsCollapsed(false);
        }
    });

    DOM.filterText.addEventListener('focus', () => DOM.searchHint.style.opacity = '0');
    DOM.filterText.addEventListener('blur', () => { if (!DOM.filterText.value) DOM.searchHint.style.opacity = '1'; });
    DOM.filterText.addEventListener('input', debounce(() => { state.filters.text = DOM.filterText.value; applyFilters(); }, 200));

    DOM.regexToggle.addEventListener('click', () => {
        state.filters.isRegex = !state.filters.isRegex;
        DOM.regexToggle.classList.toggle('is-active', state.filters.isRegex);
        DOM.filterText.classList.toggle('is-regex', state.filters.isRegex);
        applyFilters();
    });

    DOM.dropZone.addEventListener('click', event => { if (!event.target.closest('#load-example-wrapper')) DOM.fileInput.click(); });
    DOM.fileInput.addEventListener('change', event => handleFiles(event.target.files));
    DOM.openButton.addEventListener('click', () => DOM.fileInput.click());

    // Drag and Drop
    const hasFiles = event => Array.from(event.dataTransfer?.types || []).includes('Files');
    let dragCounter = 0;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        DOM.dropZone.addEventListener(eventName, event => {
            event.preventDefault();
            event.stopPropagation();
            DOM.dropZone.classList.toggle('highlight', (eventName === 'dragenter' || eventName === 'dragover') && hasFiles(event));
            if (eventName === 'drop') handleFiles(event.dataTransfer.files);
        });

        window.addEventListener(eventName, event => {
            event.preventDefault();
            if (eventName === 'dragover' || !hasFiles(event)) return;
            if (eventName === 'dragenter') dragCounter++;
            else if (eventName === 'dragleave') dragCounter--;
            else if (eventName === 'drop') dragCounter = 0, handleFiles(event.dataTransfer.files);

            DOM.dragOverlay.classList.toggle('is-hidden', dragCounter <= 0);
            if (dragCounter < 0) dragCounter = 0;
        });
    });

    DOM.loadExampleWrapper.addEventListener('click', async event => {
        event.preventDefault();
        event.stopPropagation();
        try {
            if (!(await loadSarifFromScript('sarif-example', "Unknown"))) showError("Example data not found.");
        } catch (err) {
            showError(`Failed to load: ${err.message}`);
        }
    });

    DOM.issueList.addEventListener('click', event => {
        const icon = event.target.closest('.severity-icon');
        if (icon) {
            event.preventDefault();
            event.stopPropagation();
            const group = icon.closest('.issue-group');
            if (!group) return;

            const isCollapsed = group.classList.toggle('is-collapsed');
            const use = icon.querySelector('use');
            const href = use.getAttribute('href');
            use.setAttribute('href', isCollapsed ? href.replace('-fill', '-outline') : href.replace('-outline', '-fill'));
            return;
        }
        const locationButton = event.target.closest('.issue-location');
        if (locationButton) {
            event.preventDefault();
            copyToClipboard(locationButton.textContent);
        }
    });

    DOM.metrics.grid.addEventListener('click', event => handlePillClick(event, 'severities'));
    Object.entries(DOM.filters).forEach(([type, config]) => {
        config.group.addEventListener('click', event => handlePillClick(event, type));
    });
    // #endregion

    // #region Initialization
    function initTheme() {
        const saved = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(saved || (systemPrefersDark ? 'dark' : 'light'), false);
    }

    function initExample() {
        const exampleElement = document.getElementById('sarif-example');
        if (!exampleElement) return;

        const project = exampleElement.getAttribute('data-project');
        const src = exampleElement.getAttribute('data-src');

        const message = project ? `load report from <strong>${sanitize(project)}</strong> project`
                      : src ? `load <strong>${sanitize(src)}</strong> report`
                      : null;

        if (!message) return;

        DOM.loadExampleWrapper.innerHTML = message;
        DOM.exampleContainer.classList.remove('is-hidden');
    }

    async function init() {
        Perf.start('App Init');
        let loaded = false;

        initTheme();
        initExample();
        readURL();

        try {
            loaded = await loadSarifFromScript('sarif-report', "Embedded Report", true);
        } catch (err) {
            showError(`Error processing embedded report: ${err.message}`);
            console.error(err);
        } finally {
            DOM.loaderContainer.classList.add('is-hidden');
            if (!loaded) DOM.dropZone.classList.remove('is-hidden');
        }
        Perf.end('App Init');
    }
    // #endregion

    init();
</script>
</body>
</html>
